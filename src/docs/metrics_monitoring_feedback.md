# Метрики, мониторинг и обратная связь

Цель: выполнить QAP пункты про (1) количественные метрики, (2) ключевую метрику надежности и инструмент мониторинга, (3) сбор feedback (CSI/NPS) с периодическим prompt.

## 1. Ключевые метрики (KPI/SLI)

### 1.1. Надежность (ключевая контролируемая метрика)

Выбрать 1 «ключевую» (для self-check) и 2–3 вспомогательных:

- Key metric (пример): **Crash‑free sessions (%)** для iOS клиента.
- Вспомогательные:
  - API error rate (5xx/4xx/429) по endpoint’ам gateway.
  - p95 TTFT и p95 полного ответа по UC‑04 (чат).
  - Доля успешных завершений ключевого сценария (success rate UC‑04).
  - Доля отмен (cancel rate) и повторов (retry rate).
  - WireGuard tunnel health: uptime, handshake age, packet loss/latency (если доступно).

Инструменты мониторинга (примерный набор):

- Для клиента: Sentry или Firebase Crashlytics (crashes, non‑fatal errors).
- Для backend/инфры: Prometheus + Grafana (метрики), Loki/ELK (логи), OpenTelemetry (трейсы).
- Альтернатива/дополнение: Zabbix для инфраструктурных метрик и алертов.

### 1.2. Производительность

- Cold start p50/p95.
- TTFT (p50/p95) и полное время ответа (p50/p95) в чате.
- Размер ответов API и объем трафика за сессию.

### 1.3. UX/продукт

- Retention D1/D7 (если есть аналитика).
- Session length.
- Конверсия в «успешное завершение сценария».
- CSI/NPS по сценариям.

## 2. Дашборды и алерты (минимум)

- Dashboard‑1: Home Gateway health — RPS, error rate, p95 latency/TTFT, активные стримы.
- Dashboard‑2: Ollama host — CPU/RAM/VRAM, температура/троттлинг (если доступно), загрузка диска.
- Dashboard‑3: Mobile stability — crash‑free sessions, топ ошибок, TTFT по устройствам/сетям.
- Dashboard‑4: VPS/WireGuard — handshake age, трафик, доступность edge, 4xx/5xx на публичном прокси.

Алерты (пример):

- Error rate > T% за 5 минут.
- p95 TTFT > X ms за 10 минут.
- Доля 401/403 растет (проблемы с токеном/pairing).
- Crash‑free sessions < Y% за сутки.
- WireGuard handshake отсутствует > N минут (домашний ПК недоступен).

## 3. Сбор обратной связи (CSI/NPS)

### 3.1. Каналы

- Кнопка «Обратная связь» (минимум для 1 балла).
- Периодический prompt (для 2 баллов): показывать после завершения ключевого сценария.

### 3.2. Правила показа prompt (рекомендации)

- Не чаще 1 раза в N дней (rate‑limit).
- Не показывать, если пользователь уже ответил в текущем релизе.
- Не показывать, если в текущей сессии был crash/критическая ошибка (избежать раздражения).

### 3.3. Что сохранять (privacy-friendly)

- Оценка (NPS 0–10 или CSI 1–5), опциональный комментарий.
- Контекст: версия приложения, OS, экран/сценарий, timestamp.
- Не сохранять PII без необходимости.

## 4. Процесс улучшений (замкнутый цикл)

1) Собрать метрики/feedback → 2) Найти топ‑проблемы → 3) Завести задачи → 4) Исправить → 5) Повторно измерить.

Артефакты для защиты/оценки:

- Скриншоты дашбордов (Grafana/Crash tool).
- Пример алерта и его разбор.
- Короткий отчет «до/после» по 1–2 метрикам.
