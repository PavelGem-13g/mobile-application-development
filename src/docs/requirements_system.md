# Требования ко всей системе (System Requirements)

## 1. Цель системы

Система «MAD Application» — мобильное приложение (iOS, SwiftUI) и домашняя серверная часть на компьютере пользователя, которые позволяют безопасно обращаться к локально запущенной LLM (Ollama) с телефона, контролируя качество (надежность, производительность, безопасность, UX) и улучшая продукт на основе измеримых метрик и обратной связи.

## 2. Область применения и границы

### Входит в систему

- Мобильный клиент iOS (SwiftUI) — основной пользовательский интерфейс.
- Домашний LLM endpoint (Ollama) — выполнение inference по запросам.
- Домашний API Gateway / BFF (рекомендуется) — аутентификация, проксирование, rate limit, observability.
- VPS (public IP) — безопасная точка входа для доступа извне, VPN сервер (AmneziaWG) и reverse proxy до домашнего gateway.
- Сервисы качества (observability): мониторинг, сбор логов/трейсов, алерты.
- Сервис обратной связи (CSI/NPS, тикеты/сообщения).
- Аналитика продуктовых событий (ретеншн, конверсия, время сессии).

### Не входит (но учитывается как интеграции)

- Магазины приложений (App Store Connect), MDM.
- Email/SMS‑провайдеры (если используются).
- Сторонние платежи/реклама (если будут — отдельное расширение требований).
- VPN/туннелирование как продукт (WireGuard/Tailscale/Cloudflare Tunnel) — как инфраструктурная интеграция для безопасного доступа извне домашней сети.

## 3. Стейкхолдеры

- Пользователь (конечный клиент): хочет быстро и понятно решать задачу продукта X.
- Команда разработки: хочет стабильную архитектуру, тестируемость, наблюдаемость.
- Преподаватель/оценщик: проверяет полноту требований и зрелость quality‑подхода.

## 4. Основные пользовательские сценарии (уровень системы)

Доменные сценарии для «LLM с домашнего ПК»:

- UC‑01: Онбординг/первый запуск — пользователь понимает схему «телефон → домашний ПК → Ollama», выбирает способ подключения (домашний Wi‑Fi / VPN).
- UC‑02: Подключение к домашнему endpoint — ввод адреса/пары устройства, проверка доступности, сохранение профиля подключения.
- UC‑03: Выбор модели — пользователь получает список доступных моделей Ollama и выбирает модель по умолчанию.
- UC‑04: Чат с LLM — отправка промпта, получение ответа (в т.ч. streaming), история диалога.
- UC‑05: Повтор/остановка генерации — retry при ошибках сети, cancel/stop генерации.
- UC‑06: Работа при плохой сети — понятные ошибки, деградация, очередь отправки (по выбору), таймауты и ретраи.
- UC‑07: Обратная связь о качестве — CSI/NPS prompt после завершения сессии/диалога + кнопка feedback.

## 5. Функциональные требования (FR) — уровень системы

### FR‑Conn (подключение к домашнему серверу)

- FR‑Conn‑1: Клиент должен поддерживать профиль подключения к публичному endpoint на VPS (адрес/домен, порт, режим: LAN/через VPS).
- FR‑Conn‑2: Клиент должен выполнять проверку доступности и корректности endpoint (health check) перед началом чата.
- FR‑Conn‑3: Клиент должен позволять переключать профили подключения (например, «Дом», «Извне через VPN»).

### FR‑Auth (аутентификация/доступ)

- FR‑Auth‑1: Домашний gateway должен требовать аутентификацию клиента (например, токен/ключ, mTLS или одноразовый pairing).
- FR‑Auth‑2: Клиент должен хранить секреты доступа только в iOS Keychain.
- FR‑Auth‑3: Система должна поддерживать отзыв доступа (rotation токена/ключа) и принудительную перепривязку.

### FR‑LLM (взаимодействие с Ollama/LLM)

- FR‑LLM‑1: Клиент должен позволять выбрать модель и параметры генерации (минимум: temperature; остальное опционально).
- FR‑LLM‑2: Клиент должен отправлять промпт и получать ответ, поддерживая streaming (постепенное отображение текста).
- FR‑LLM‑3: Клиент должен поддерживать stop/cancel генерации.
- FR‑LLM‑4: Клиент должен хранить историю диалогов локально (по выбору пользователя: хранить/не хранить).

### FR‑UX (UX/помощь)

- FR‑UX‑1: Система должна предоставлять онбординг по безопасному подключению (LAN/VPN, почему нельзя «просто открыть порт»).
- FR‑UX‑2: Сообщения об ошибках должны быть понятными и предлагать действие (проверить VPN/домашний ПК/повторить запрос).

### FR‑Feedback (обратная связь)

- FR‑Feedback‑1: Клиент должен содержать кнопку «Обратная связь».
- FR‑Feedback‑2: Клиент должен показывать периодический запрос оценки (CSI/NPS) после завершения ключевого сценария (не чаще N раз за период).
- FR‑Feedback‑3: Система должна сохранять ответы пользователя и связывать их с версией приложения/устройством/сессией (с учетом privacy).

### FR‑Observability (наблюдаемость качества)

- FR‑Obs‑1: Система должна собирать crash‑events клиента и серверные ошибки.
- FR‑Obs‑2: Система должна собирать метрики latency/error‑rate по API и визуализировать их.
- FR‑Obs‑3: Система должна поддерживать алерты при деградации (рост error‑rate, рост latency, падение crash‑free).

## 6. Нефункциональные требования (NFR) — уровень системы

### NFR‑Usability (юзабилити)

- NFR‑U‑1: Ключевой сценарий UC‑03 → UC‑04 должен выполняться за ≤ 3 тапа.
- NFR‑U‑2: Ошибка сети должна быть объяснена без технических терминов и с CTA.
- NFR‑U‑3: Приложение должно поддерживать Dynamic Type и VoiceOver для основных экранов.

### NFR‑Performance (производительность)

- NFR‑P‑1: Холодный старт (cold start) должен быть измеряем и улучшаться; целевое значение фиксируется как KPI (см. `src/docs/metrics_monitoring_feedback.md`).
- NFR‑P‑2: Время получения первого токена (TTFT) и полного ответа для UC‑04 при 4G/VPN должно быть в пределах целевого SLA.
- NFR‑P‑3: Расход трафика в чате должен быть ограничен (streaming, компрессия, запрет лишних повторов, лимиты размера контекста).

### NFR‑Reliability (надежность)

- NFR‑R‑1: Система должна корректно переживать переключения background/foreground без потери данных.
- NFR‑R‑2: При временной недоступности backend клиент должен деградировать «мягко» (кэш/повтор/пояснение).
- NFR‑R‑3: Должна быть определена ключевая метрика надежности и инструмент мониторинга (см. QAP).

### NFR‑Security & Privacy (безопасность и приватность)

- NFR‑S‑1: Все сетевые вызовы должны использовать TLS; запрет на небезопасные протоколы.
- NFR‑S‑2: Секреты и токены не должны попадать в логи.
- NFR‑S‑3: Данные «в покое» на устройстве должны быть защищены (Keychain + защита локального хранилища).
- NFR‑S‑4: Система должна собирать только необходимые данные (data minimization) и информировать пользователя.
- NFR‑S‑5: Доступ к домашнему endpoint извне домашней сети должен осуществляться через защищенный канал (VPN/туннель) и не должен быть доступен анонимно из интернета.
- NFR‑S‑6: Должны быть предусмотрены ограничения злоупотреблений: rate limiting, ограничение размера промпта, таймауты.
- NFR‑S‑7: Публично доступен только VPS endpoint с TLS; домашний gateway и Ollama принимают входящие соединения только из доверенной сети/WireGuard интерфейса.

### NFR‑Compatibility (совместимость)

- NFR‑C‑1: Поддерживаемые версии iOS фиксируются в требованиях (минимум iOS N).
- NFR‑C‑2: Должна быть матрица устройств для проверки (минимум 2 размера экрана).

## 7. Ограничения и допущения

- Мобильный клиент реализуется на SwiftUI (база: `src/app/mad_application`).
- Домашний gateway может быть реализован как отдельный сервис (рекомендуется) или прямой доступ к Ollama; для «2 балла» описывается сетевой ландшафт и связность сервисов.
- В dev/учебном режиме допускается использование сторонних сервисов (Sentry/Crashlytics) вместо self-hosted.

## 8. Критерии приемки (Definition of Done для QAP)

Минимум (полнота / «1 балл»):

- Есть описанная модель качества и чек‑лист.
- Есть диаграмма функциональности и список сценариев.
- Приложение запускается в IDE и на устройстве (требование QAP “installed & running”).
- Есть способ дать обратную связь (кнопка).

Максимум («2 балла»):

- Есть top‑level архитектурная диаграмма + сетевая связность сервисов/микросервисов.
- Есть модель тестирования с автоматизацией UI и performance‑тестом, а также планом load‑тестирования (по возможности — для backend).
- Есть выбранная ключевая метрика надежности + инструмент мониторинга (Prometheus/Grafana/Zabbix и/или crash monitoring).
- Есть механизм периодического CSI/NPS prompt после завершения сценария.
 - Для внешнего доступа (вне Wi‑Fi) описан безопасный способ (VPN/туннель) и запреты на небезопасные варианты.
